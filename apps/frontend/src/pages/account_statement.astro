---
import AuthProtected from "../features/auth/AuthProtected.astro"
import Layout from "../layouts/layouts.astro"
import Sidebar from '../components/Sidebar.astro';
---

<Layout title="Estado de Cuotas">
  <AuthProtected>
    <div class="flex min-h-[calc(100vh-4rem)] bg-gray-100 dark:bg-gray-900">
      <Sidebar />
      <main class="flex-1 p-4 lg:ml-48 flex flex-col gap-8 max-w-[90rem] mx-auto md:items-center">
        <div class="flex flex-col gap-4 p-4 max-w-[90rem] mx-auto md:items-center bg-white dark:bg-gray-800 rounded-lg border border-gray-300 dark:border-gray-500 shadow-md"> 
      <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Estado de cuenta</h1>
      <!-- Tabla de mensualidades pendientes -->
      <section class="w-full max-w-2xl">
        <h2 class="text-lg font-semibold mb-2 px-4">Resumen</h2>
        <div class="w-full border border-gray-300 dark:border-gray-500 rounded-md overflow-hidden ">
          <table class="w-full text-gray-800 dark:text-white">
            <tbody id="resumen-tbody">
              <tr>
                <td class="py-2 px-4 font-medium text-gray-900 dark:text-white">Cuotas pendientes</td>
                <td class="py-2 px-4 text-right" id="resumen-cantidad">-</td>
              </tr>
              <tr>
                <td class="py-2 px-4 font-medium text-gray-900 dark:text-white">Monto de la última cuota por pagar</td>
                <td class="py-2 px-4 text-right" id="resumen-ultima">-</td>
              </tr>
              <tr>
                <td class="py-2 px-4 font-medium text-gray-900 dark:text-white">Total de las cuotas pendientes</td>
                <td class="py-2 px-4 text-right" id="resumen-total">-</td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>


        <!-- Cuotas pendientes -->
        <section class="w-full max-w-2xl mt-8">
            <h2 class="text-lg font-bold mb-2">Cuotas pendientes</h2>
            <div class="flex w-full text-gray-800 dark:text-white mb-2">
              <span class="w-1/3 ">Mes</span>
              <span class="w-1/3">Fecha</span>
              <span class="w-1/3">Fecha Limite</span>
              <span class="w-1/3">Monto $</span>
            </div>
          <ul id="cuotas-pendientes-list" class="m-0 p-2 list-none overflow-auto flex flex-col gap-8 rounded-md border border-gray-300 dark:border-gray-500">
            <!-- Aquí se mostrarán las cuotas pendientes -->
          </ul>
          <div id="pendientes-loading" class="text-center py-4 hidden">Cargando cuotas...</div>
          <div id="pendientes-error" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">Error al cargar las cuotas</div>
          <div id="pendientes-empty" class="hidden text-center py-4 mb-5">No hay cuotas pendientes por pagar</div>
        </section>

          <!-- Cuotas pagadas -->
          <section class="w-full max-w-2xl mt-8">
            <h2 class="text-lg font-semibold mb-2">Cuotas pagadas</h2>
            <ul id="cuotas-pagadas-list" class="m-0 p-2 list-none overflow-auto flex flex-col gap-8 rounded-md border border-green-300">
              <!-- Aquí se mostrarán las cuotas pagadas -->
            </ul>
            <div id="pagadas-loading" class="text-center py-4 hidden">Cargando cuotas...</div>
            <div id="pagadas-error" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">Error al cargar las cuotas</div>
            <div id="pagadas-empty" class="hidden text-center py-4">No hay cuotas pagadas</div>
          </section>
        </div>
      </main>
    </div>
    </AuthProtected>
  </Layout>


        <script>
          // @ts-nocheck
          import ky from "ky";
          import { BACK_ENDPOINT } from "../config/endpoints";

          const cuotasList = document.querySelector('#cuotas-pendientes-list');
          const loading = document.querySelector('#pendientes-loading');
          const error = document.querySelector('#pendientes-error');
          const empty = document.querySelector('#pendientes-empty');

          // Elementos para cuotas pagadas
          const cuotasPagadasList = document.querySelector('#cuotas-pagadas-list');
          const pagadasLoading = document.querySelector('#pagadas-loading');
          const pagadasError = document.querySelector('#pagadas-error');
          const pagadasEmpty = document.querySelector('#pagadas-empty');

          async function loadCuotasAndPagos() {
            try {
              loading.classList.remove('hidden');
              error.classList.add('hidden');
              empty.classList.add('hidden');
              cuotasList.innerHTML = '';
              pagadasLoading.classList.remove('hidden');
              pagadasError.classList.add('hidden');
              pagadasEmpty.classList.add('hidden');
              cuotasPagadasList.innerHTML = '';

                // Elementos resumen
                const resumenCantidad = document.getElementById('resumen-cantidad');
                const resumenUltima = document.getElementById('resumen-ultima');
                const resumenTotal = document.getElementById('resumen-total');

              // Obtener todas las cuotas y pagos del usuario
              const [cuotas, pagos] = await Promise.all([
                ky.get(`${BACK_ENDPOINT}/api/cuotas`, { credentials: 'include' }).json(),
                ky.get(`${BACK_ENDPOINT}/api/payment`, { credentials: 'include' }).json()
              ]);

              // Filtrar pagos aceptados
              const pagosAceptados = pagos.filter(pago => pago.status === 'accepted');
              const cuotasPagadasIds = pagosAceptados.map(pago => pago.cuota_id);

              // Mostrar cuotas pagadas
              const pagadas = cuotas.filter(cuota => cuotasPagadasIds.includes(cuota.id));
              if (pagadas.length === 0) {
                pagadasEmpty.classList.remove('hidden');
              } else {
                pagadas.sort((a, b) => new Date(a.date) - new Date(b.date));
                for (const cuota of pagadas) {
                  // Buscar el pago correspondiente para mostrar el status
                  const pago = pagosAceptados.find(p => p.cuota_id === cuota.id);
                  const status = pago ? pago.status : '';
                  const li = document.createElement('li');
                  li.className = "flex gap-4 justify-between items-center";
                  li.innerHTML = `
                    <div class="flex flex-wrap md:flex-nowrap gap-2 flex-grow">
                      <input class="w-full bg-green-600 rounded-md p-2 outline-none text-white" type="text" value="${cuota.description}" readonly>
                      <input class="w-full bg-green-600 rounded-md p-2 outline-none text-white" type="text" value="${cuota.date.split('T')[0]}" readonly>
                      <input class="w-full bg-green-600 rounded-md p-2 outline-none text-white" type="text" value="${cuota.date_limit.split('T')[0]}" readonly>
                      <input class="w-full bg-green-600 rounded-md p-2 outline-none text-white" type="text" value="${cuota.monto}" readonly>
                      <input class="w-full bg-green-600 rounded-md p-2 outline-none text-white" type="text" value="${status}" readonly>
                    </div>
                  `;
                  cuotasPagadasList.appendChild(li);
                }
              }

              // Mostrar cuotas pendientes (no pagadas)
              const pendientes = cuotas.filter(cuota => !cuotasPagadasIds.includes(cuota.id));

                // Tabla Resumen
                resumenCantidad.textContent = pendientes.length;
                if (pendientes.length > 0) {
                  // Ordenar por fecha para obtener la última
                  pendientes.sort((a, b) => new Date(b.date) - new Date(a.date));
                  resumenUltima.textContent = pendientes[0].monto + '$';
                  resumenTotal.textContent = pendientes.reduce((acc, cuota) => acc + Number(cuota.monto), 0) + '$';
                } else {
                  resumenUltima.textContent = '-';
                  resumenTotal.textContent = '0$';
                }
                
              if (pendientes.length === 0) {
                empty.classList.remove('hidden');
              } else {
                pendientes.sort((a, b) => new Date(a.date) - new Date(b.date));
                const now = new Date();
                for (const cuota of pendientes) {
                  const limitDate = new Date(cuota.date_limit);
                  const isOverdue = limitDate < now;
                  const bgClass = isOverdue ? 'bg-red-600' : 'bg-gray-600';
                  const li = document.createElement('li');
                  li.className = "flex gap-4 justify-between items-center";
                  li.innerHTML = `
                    <div class="flex flex-wrap md:flex-nowrap gap-2 flex-grow">
                      <input class="w-full ${bgClass} rounded-md p-2 outline-none text-white" type="text" value="${cuota.description}" readonly>
                      <input class="w-full ${bgClass} rounded-md p-2 outline-none text-white" type="text" value="${cuota.date.split('T')[0]}" readonly>
                      <input class="w-full ${bgClass} rounded-md p-2 outline-none text-white" type="text" value="${cuota.date_limit.split('T')[0]}" readonly>
                      <input class="w-full ${bgClass} rounded-md p-2 outline-none text-white" type="text" value="${cuota.monto}" readonly>
                    </div>
                  `;
                  cuotasList.appendChild(li);
                }
              }
            } catch (e) {
              error.classList.remove('hidden');
              pagadasError.classList.remove('hidden');
            } finally {
              loading.classList.add('hidden');
              pagadasLoading.classList.add('hidden');
            }
          }

          loadCuotasAndPagos();
        </script>