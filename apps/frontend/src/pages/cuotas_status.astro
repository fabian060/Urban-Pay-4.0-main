---
import AuthProtected from "../features/auth/AuthProtected.astro"
import Layout from "../layouts/layouts.astro"
import Sidebar from "../components/Sidebar.astro"
---

<Layout title="Estado de Cuotas">
  <AuthProtected>
    <div class="flex min-h-[calc(100vh-4rem)] bg-gray-100 dark:bg-gray-900">
      <Sidebar />
      <main class="flex flex-col gap-8 p-4 max-w-[90rem] mx-auto md:items-center w-full">
        <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Reportes de Pago</h1>
        
        <div id="payments-container" class="w-full md:w-[70%] lg:w-[50%]">
          <div class="flex gap-4 mb-4">
            <button id="btn-por-revisar" class="px-4 py-2 rounded bg-blue-500 text-white font-bold">Por revisar</button>
            <button id="btn-revisado" class="px-4 py-2 rounded bg-green-500 text-white font-bold">Revisado</button>
            <button id="btn-todos" class="px-4 py-2 rounded bg-gray-500 text-white font-bold">Todos</button>
          </div>
          <div id="payments-list" class="m-0 p-2 list-none overflow-auto flex flex-col gap-4 rounded-md border border-gray-300 dark:border-gray-500 bg-white dark:bg-gray-600/40">
            <template id="payment-item-template">
              <div class="p-4 border border-gray-300 dark:border-gray-500 text-gray-900 bg-white rounded-lg dark:bg-gray-600/40">
                  <h3 class="font-semibold text-lg text-gray-600 dark:text-gray-300">Reporte #<span class="payment-id">0</span></h3>
                  <p class="my-1 text-gray-600 dark:text-gray-300"><strong>Casa:</strong> <span class="user-house-number">Q-000</span></p>
                  <p class="my-1 text-gray-600 dark:text-gray-300"><strong>Fecha:</strong> <span class="payment-date">01-01-2023</span></p>
                  <p class="my-1 text-gray-600 dark:text-gray-300"><strong>Referencia:</strong> <span class="payment-reference">1234</span></p>
                  <p class="my-1 text-gray-600 dark:text-gray-300"><strong>Monto:</strong> 
                    <span class="my-1 text-gray-600 dark:text-gray-300">0.00</span>
                  </p>
                  <p class="my-1 text-gray-600 dark:text-gray-300"><strong>Estado:</strong> 
                    <span class="status pending bg-yellow-100 text-yellow-800 px-2 py-1 rounded text-sm font-medium">
                      Pendiente
                    </span>
                  </p>
                <div class="mt-3 flex gap-2">
                  <button class="btn-accept bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed">
                    Aceptar
                  </button>
                  <button class="btn-reject bg-red-600 text-white px-3 py-1 rounded hover:bg-red-700 disabled:opacity-50 disabled:cursor-not-allowed">
                    Rechazar
                  </button>
                </div>
              </div>
            </template>
          </div>
          
    <div id="loading" class="text-center py-8">
            <p>Cargando reportes...</p>
          </div>
          
    <div id="error" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">
            <p>Error al cargar los reportes</p>
          </div>
          
    <div id="empty" class="hidden text-center py-8">
            <p>No hay reportes de pago pendientes</p>
          </div>
        </div>
      </main>
    </div>
  </AuthProtected>
</Layout>

<script>
  // @ts-nocheck
  import ky from "ky";
  import { BACK_ENDPOINT } from "../config/endpoints";
  import { createNotification } from "../features/notifications/notificiation.js";

  const paymentsContainer = document.querySelector('#payments-container');
  const paymentsList = document.querySelector('#payments-list');
  const paymentItemTemplate = document.querySelector('#payment-item-template');
  const loadingElement = document.querySelector('#loading');
  const errorElement = document.querySelector('#error');
  const emptyElement = document.querySelector('#empty');

  async function loadPayments() {
    try {
      loadingElement.classList.remove('hidden');
      errorElement.classList.add('hidden');
      emptyElement.classList.add('hidden');
      
      const payments = await ky.get(`${BACK_ENDPOINT}/api/payment`, {
        credentials: 'include'
      }).json();
      
      paymentsList.innerHTML = '';
      
      if (payments.length === 0) {
        emptyElement.classList.remove('hidden');
        return;
      }
      
      // Filtrar según el tipo seleccionado
      let tipoFiltro = window.tipoFiltroPagos || 'por-revisar';
      let filteredPayments = [];
      if (tipoFiltro === 'todos') {
        filteredPayments = payments;
      } else if (tipoFiltro === 'por-revisar') {
        filteredPayments = payments.filter(p => p.status === 'pending');
      } else {
        filteredPayments = payments.filter(p => ['accepted', 'rejected'].includes(p.status));
      }
      
      // Lógica de ordenamiento
      if (tipoFiltro === 'todos') {
        // En la vista "Todos", los pendientes van primero, luego se ordena por fecha
        filteredPayments.sort((a, b) => {
          const statusA = a.status === 'pending' ? 0 : 1;
          const statusB = b.status === 'pending' ? 0 : 1;
          if (statusA !== statusB) return statusA - statusB;
          return new Date(a.date) - new Date(b.date); // Orden secundario por fecha
        });
      } else {
        // Para las otras vistas, solo ordenar por fecha ascendente
        filteredPayments.sort((a, b) => new Date(a.date) - new Date(b.date));
      }

      function createPaymentItem(payment) {
        const paymentItem = paymentItemTemplate.content.cloneNode(true).children[0];
        // Actualizar la información del pago
        paymentItem.querySelector('.payment-id').textContent = payment.id;
        paymentItem.querySelector('.user-house-number').textContent = payment.house_number;
        paymentItem.querySelector('.payment-date').textContent = new Date(payment.date).toLocaleDateString();
        paymentItem.querySelector('.payment-reference').textContent = payment.payment_reference;
        paymentItem.querySelector('span.my-1').textContent = payment.monto ? Number(payment.monto).toFixed(2) : '0.00';
        // Bloquear botones si la cuota ya fue aceptada o rechazada
        const btnAccept = paymentItem.querySelector('.btn-accept');
        const btnReject = paymentItem.querySelector('.btn-reject');
        const isBlocked = payment.status === 'accepted' || payment.status === 'rejected';
        btnAccept.disabled = isBlocked;
        btnReject.disabled = isBlocked;
        // Asignar eventos solo si no está bloqueado
        if (!isBlocked) {
          btnAccept.addEventListener('click', () => handlePaymentAction(payment.id, 'accepted'));
          btnReject.addEventListener('click', () => handlePaymentAction(payment.id, 'rejected'));
        }

        // Actualizar el estatus visual
        const statusSpan = paymentItem.querySelector('.status');
        statusSpan.classList.remove('pending', 'accepted', 'rejected', 'bg-yellow-100', 'text-yellow-800');
        // Asignar clase y texto según el estatus
        if (payment.status === 'accepted') {
          statusSpan.classList.add('accepted');
          statusSpan.textContent = 'Aceptado';
        } else if (payment.status === 'rejected') {
          statusSpan.classList.add('rejected');
          statusSpan.textContent = 'Rechazado';
        } else {
          statusSpan.classList.add('pending', 'bg-yellow-100', 'text-yellow-800');
          statusSpan.textContent = 'Pendiente';
        }
        return paymentItem;
      }

      for (const payment of filteredPayments) {
        paymentsList.appendChild(createPaymentItem(payment));
      }
      
    } catch (error) {
      console.error('Error loading payments:', error);
      errorElement.classList.remove('hidden');
      if (error.response?.status === 401 || error.response?.status === 403) {
        location.replace('/login');
      }
    } finally {
      loadingElement.classList.add('hidden');
    }
  }

  async function handlePaymentAction(paymentId, action) {
    try {
      const response = await ky.patch(`${BACK_ENDPOINT}/api/payment/${paymentId}/status`, {
        json: { status: action },
        credentials: 'include'
      }).json();

      createNotification({
        title: `Pago ${action === 'accepted' ? 'aceptado' : 'rechazado'}`,
        type: 'success'
      });

      // Recargar la lista
      await loadPayments();

    } catch (error) {
      console.error('Error updating payment status:', error);
      const errorData = await error.response?.json();
      createNotification({
        title: 'Error al procesar la acción',
        description: errorData?.error || 'Error desconocido',
        type: 'error'
      });
    }
  }

  // Botones de filtro
  document.getElementById('btn-todos').onclick = () => {
    window.tipoFiltroPagos = 'todos';
    loadPayments();
  };
  document.getElementById('btn-por-revisar').onclick = () => {
    window.tipoFiltroPagos = 'por-revisar';
    loadPayments();
  };
  document.getElementById('btn-revisado').onclick = () => {
    window.tipoFiltroPagos = 'revisado';
    loadPayments();
  };
  // Cargar los pagos al iniciar
  loadPayments();
</script>
